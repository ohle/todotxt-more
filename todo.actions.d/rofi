#!/bin/bash

# install this in the ~/.todo.actions.d dir 

# by Maarten van Gompel (proycon) proycon@anaproy.nl
# GNU Public License v3

striptags() {
    sed -e 's/<[^>]*>//g'
}

action=$1
shift

[ "$action" = "usage" ] && {
  echo "  Fuzzy search:"
  echo "    rofi [ACTIONS]"
  echo "      pass actions through rofi and make them actionable"
  echo ""
  exit
}

if [ $# -eq 0 ]; then
    set -- list
fi

[ -z $TERMINAL_CMD ] && TERMINAL_CMD="foot -e"

itemno=""
while true; do
    result=$($TODO_FULL_SH relsort "$@" | $TODO_FULL_SH format pango stdin | rofi -matching glob -tokenize -i -no-sort -no-levenshtein-sort -markup -markup-rows -dmenu -p ">" -mesg "todo.txt" -kb-custom-1 "Alt-a" -kb-custom-2 "Alt-e" -kb-custom-3 "Alt-d")
    ret=$?
    itemno=$(echo "$result" | striptags | grep -Po "\d+ .*$" | cut -d" " -f 1)
    case $ret in
        10)
            $TERMINAL_CMD $TODO_FULL_SH edit "999999"
            break
            ;;
        11)
            $TERMINAL_CMD $TODO_FULL_SH edit "$itemno"
            break
            ;;
        12)
            $TODO_FULL_SH done "$itemno"
            ;;
        0)
            if [ -n "$itemno" ]; then
                item=$($TODO_FULL_SH format pango show "$itemno")
                action=$($TODO_FULL_SH actionmenu | rofi -matching glob -tokenize -i -no-levenshtein-sort -markup -markup-rows -dmenu -mesg "$item" | striptags | grep -P "[\dABCq] .*" | cut -d" " -f 1) 

                if [ "$action" = "q" ] || [ -z "$action" ]; then
                    break
                fi
                if ! $TODO_FULL_SH actionmenu "$action" "$itemno"; then
                    break
                fi
                sleep 1
            else
                break
            fi
            ;;
        *)
            break
    esac
done

